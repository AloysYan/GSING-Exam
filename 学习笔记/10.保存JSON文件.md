## 保存 JSON 文件代码详解

### 一、整体功能

将检测结果保存为 JSON，包含文件名、检测到的方块信息、颜色统计。

### 二、代码逐行解析

#### 第 86-90 行：构建输出字典

```86:90:T3/T3.py
out = {
    'filename': image_path,
    'detections': detections,
    'color_counts': color_count
}
```

**数据结构说明：**

1. `'filename'`：字符串，图像文件名
   - 值：`image_path`（如 `"image2.png"`）

2. `'detections'`：列表，所有检测到的方块信息
   - 值：`detections`（在循环中填充）
   - 每个元素是一个字典，包含：
     ```python
     {
         'cx': 中心x坐标,
         'cy': 中心y坐标,
         'size_px': 尺寸（像素）,
         'angle_deg': 旋转角度（度）,
         'color': 颜色名称
     }
     ```

3. `'color_counts'`：字典，各颜色的统计数量
   - 值：`color_count`（如 `{'red': 2, 'green': 1, 'blue': 1, 'yellow': 0}`）

**示例输出结构：**
```python
out = {
    'filename': 'image2.png',
    'detections': [
        {'cx': 100, 'cy': 150, 'size_px': 50, 'angle_deg': -15, 'color': 'red'},
        {'cx': 200, 'cy': 250, 'size_px': 45, 'angle_deg': 30, 'color': 'green'},
        # ... 更多检测结果
    ],
    'color_counts': {'red': 2, 'green': 1, 'blue': 1, 'yellow': 0}
}
```

#### 第 91 行：打开文件（使用上下文管理器）

```91:91:T3/T3.py
with open("T3/Output/Out_json.json", "w", encoding="utf-8") as json_file:
```

**语法解析：**

1. `with` 语句：上下文管理器，自动处理文件关闭
   - 进入时打开文件
   - 退出时自动关闭（即使出错）

2. `open()` 函数参数：
   - `"T3/Output/Out_json.json"`：文件路径
   - `"w"`：写入模式（覆盖）
   - `encoding="utf-8"`：UTF-8 编码，支持中文

3. `as json_file`：将文件对象赋值给 `json_file`

**文件模式说明：**
| 模式 | 说明 |
|------|------|
| `"r"` | 只读 |
| `"w"` | 写入（覆盖） |
| `"a"` | 追加 |
| `"x"` | 创建（文件存在则失败） |
| `"r+"` | 读写 |

#### 第 92 行：写入 JSON 数据

```92:92:T3/T3.py
    json.dump(out, json_file, ensure_ascii=False, indent=2)
```

**函数：`json.dump()`**

**函数签名：**
```python
json.dump(obj, fp, ensure_ascii=True, indent=None, ...)
```

**参数说明：**

| 参数 | 类型 | 说明 |
|------|------|------|
| `obj` | `dict/list` | 要序列化的对象（这里是 `out` 字典） |
| `fp` | 文件对象 | 写入的文件对象（这里是 `json_file`） |
| `ensure_ascii` | `bool` | 是否只使用 ASCII 字符 |
| `indent` | `int` | 缩进空格数（美化输出） |

**参数详解：**

1. `out`：要写入的字典对象

2. `json_file`：文件对象（由 `with` 语句打开）

3. `ensure_ascii=False`：
   - `True`：非 ASCII 字符转义（如 `\u4e2d`）
   - `False`：保留原始字符（如中文）
   - 代码中设为 `False` 以保留中文

4. `indent=2`：
   - `None`：单行输出
   - 数字：每级缩进空格数
   - 代码中设为 `2` 以美化输出

### 三、JSON 输出示例

**使用 `indent=2` 和 `ensure_ascii=False` 的输出：**
```json
{
  "filename": "image2.png",
  "detections": [
    {
      "cx": 100,
      "cy": 150,
      "size_px": 50,
      "angle_deg": -15,
      "color": "red"
    },
    {
      "cx": 200,
      "cy": 250,
      "size_px": 45,
      "angle_deg": 30,
      "color": "green"
    }
  ],
  "color_counts": {
    "red": 2,
    "green": 1,
    "blue": 1,
    "yellow": 0
  }
}
```

**如果使用 `indent=None` 的输出：**
```json
{"filename": "image2.png", "detections": [{"cx": 100, "cy": 150, "size_px": 50, "angle_deg": -15, "color": "red"}], "color_counts": {"red": 2, "green": 1, "blue": 1, "yellow": 0}}
```

### 四、`with` 语句的优势

**不使用 `with`（不推荐）：**
```python
json_file = open("T3/Output/Out_json.json", "w", encoding="utf-8")
json.dump(out, json_file, ensure_ascii=False, indent=2)
json_file.close()  # 必须手动关闭，如果出错可能不会执行
```

**使用 `with`（推荐）：**
```python
with open("T3/Output/Out_json.json", "w", encoding="utf-8") as json_file:
    json.dump(out, json_file, ensure_ascii=False, indent=2)
# 自动关闭文件，即使出错也会关闭
```

**优势：**
1. 自动资源管理：退出时自动关闭
2. 异常安全：即使出错也会关闭
3. 代码简洁：无需手动关闭

### 五、编码说明

**`encoding="utf-8"` 的重要性：**

- 支持中文和特殊字符
- 跨平台兼容性好
- 避免编码错误

**如果不指定编码（Python 3）：**
- Windows：可能使用系统默认编码（如 GBK），导致中文乱码
- Linux/Mac：通常默认 UTF-8

**最佳实践：** 始终显式指定 `encoding="utf-8"`

### 六、文件路径说明

```python
"T3/Output/Out_json.json"
```

**路径结构：**
- `T3/`：目录
- `Output/`：输出目录
- `Out_json.json`：JSON 文件名

**注意事项：**
- 如果 `T3/Output/` 目录不存在，会抛出 `FileNotFoundError`
- 建议在代码中添加目录检查或创建逻辑

### 七、JSON 模块的其他函数

**`json.dump()` vs `json.dumps()`：**

| 函数 | 用途 | 输出 |
|------|------|------|
| `json.dump()` | 写入文件 | 直接写入文件对象 |
| `json.dumps()` | 转换为字符串 | 返回 JSON 字符串 |

**示例对比：**
```python
# json.dump() - 直接写入文件
with open("file.json", "w") as f:
    json.dump(data, f)

# json.dumps() - 转换为字符串
json_str = json.dumps(data)
print(json_str)  # 打印 JSON 字符串
with open("file.json", "w") as f:
    f.write(json_str)  # 手动写入
```

### 八、错误处理建议

当前代码没有错误处理，可以添加：

```python
try:
    with open("T3/Output/Out_json.json", "w", encoding="utf-8") as json_file:
        json.dump(out, json_file, ensure_ascii=False, indent=2)
    print("JSON 文件保存成功")
except FileNotFoundError:
    print("错误：输出目录不存在")
except PermissionError:
    print("错误：没有写入权限")
except Exception as e:
    print(f"错误：保存 JSON 文件时发生异常 - {e}")
```

### 九、数据流总结

```
检测循环
    ↓
detections.append({...})  # 收集检测结果
    ↓
color_count[cname] += 1  # 统计颜色数量
    ↓
构建 out 字典
    ↓
打开 JSON 文件
    ↓
json.dump() 写入数据
    ↓
自动关闭文件
    ↓
JSON 文件保存完成
```

### 总结

这段代码实现了：
1. 构建输出字典（第 86-90 行）
2. 使用上下文管理器打开文件（第 91 行）
3. 写入格式化的 JSON 数据（第 92 行）

通过 `with` 语句和 `json.dump()`，将检测结果保存为结构化的 JSON 文件，便于后续读取和分析。