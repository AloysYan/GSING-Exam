读取代码，整理并介绍程序中使用的 OpenCV 函数和方法：


[2 tools called]


# T2.py 程序中使用的 OpenCV 函数详解

## 目录
- [一、视频捕获相关函数](#一视频捕获相关函数)
- [二、颜色空间转换](#二颜色空间转换)
- [三、颜色阈值处理](#三颜色阈值处理)
- [四、位运算操作](#四位运算操作)
- [五、轮廓检测与分析](#五轮廓检测与分析)
- [六、图像矩计算](#六图像矩计算)
- [七、绘图函数](#七绘图函数)
- [八、窗口显示与控制](#八窗口显示与控制)
- [九、OpenCV 常量](#九opencv-常量)

---

## 一、视频捕获相关函数

### 1. `cv2.VideoCapture()`

**功能：** 创建视频捕获对象，用于从摄像头或视频文件读取帧

**用法：**
```python
cap = cv2.VideoCapture(0)
```

**参数说明：**
- `0`: 摄像头索引（0 表示默认摄像头）
- 也可以传入视频文件路径，如 `"video.mp4"`

**返回值：** VideoCapture 对象

**在程序中的位置：** 第131行

---

### 2. `cap.isOpened()`

**功能：** 检查视频捕获对象是否成功打开

**用法：**
```python
if not cap.isOpened():
    print("无法打开摄像头")
    return
```

**返回值：** 
- `True`: 成功打开
- `False`: 打开失败

**在程序中的位置：** 第132行

---

### 3. `cap.set()`

**功能：** 设置视频捕获对象的属性

**用法：**
```python
cap.set(cv2.CAP_PROP_FRAME_WIDTH, 1280)
cap.set(cv2.CAP_PROP_FRAME_HEIGHT, 960)
cap.set(cv2.CAP_PROP_FPS, 60)
```

**参数说明：**
- `cv2.CAP_PROP_FRAME_WIDTH`: 设置帧宽度（像素）
- `cv2.CAP_PROP_FRAME_HEIGHT`: 设置帧高度（像素）
- `cv2.CAP_PROP_FPS`: 设置帧率（fps）

**返回值：** 布尔值，表示设置是否成功

**在程序中的位置：** 第137-139行

---

### 4. `cap.read()`

**功能：** 从视频捕获对象读取一帧图像

**用法：**
```python
ret, frame = cap.read()
```

**返回值：**
- `ret`: 布尔值，表示是否成功读取
- `frame`: numpy 数组，表示读取的图像（BGR 格式）

**在程序中的位置：** 第150行

---

### 5. `cap.release()`

**功能：** 释放视频捕获对象，释放摄像头资源

**用法：**
```python
cap.release()
```

**在程序中的位置：** 第239行

---

## 二、颜色空间转换

### `cv2.cvtColor()`

**功能：** 将图像从一种颜色空间转换到另一种颜色空间

**用法：**
```python
hsv_frame = cv2.cvtColor(frame, cv2.COLOR_BGR2HSV)
```

**参数说明：**
- `frame`: 输入图像（BGR 格式）
- `cv2.COLOR_BGR2HSV`: 转换标志，表示从 BGR 转换到 HSV

**返回值：** 转换后的图像（HSV 格式）

**在程序中的位置：** 第76行、第175行

**说明：**
- BGR 是 OpenCV 默认格式（蓝-绿-红）
- HSV 更适合颜色识别（色相-饱和度-明度）

---

## 三、颜色阈值处理

### `cv2.inRange()`

**功能：** 根据颜色范围创建二值掩码，用于颜色过滤

**用法：**
```python
mask_food = cv2.inRange(hsv_image, self.food_lower, self.food_upper)
```

**参数说明：**
- `hsv_image`: 输入的 HSV 图像
- `self.food_lower`: 颜色范围的下限（HSV 值）
- `self.food_upper`: 颜色范围的上限（HSV 值）

**返回值：** 二值掩码图像（uint8 类型）
- 在范围内的像素值为 255（白色）
- 不在范围内的像素值为 0（黑色）

**在程序中的位置：** 第30-34行

**示例：**
```python
# 检测绿色（食品）
mask_food = cv2.inRange(hsv_image, np.array([35, 40, 40]), np.array([85, 255, 255]))

# 检测红色（药品）- 需要两个范围合并
mask_medicine1 = cv2.inRange(hsv_image, np.array([0, 100, 100]), np.array([10, 255, 255]))
mask_medicine2 = cv2.inRange(hsv_image, np.array([170, 100, 100]), np.array([180, 255, 255]))
```

---

## 四、位运算操作

### 1. `cv2.bitwise_and()`

**功能：** 对两个图像进行按位与运算，常用于掩码操作

**用法：**
```python
roi_food = cv2.bitwise_and(mask_food, mask_food, mask=roi_mask)
```

**参数说明：**
- `mask_food`: 第一个输入图像（颜色掩码）
- `mask_food`: 第二个输入图像（通常与第一个相同）
- `mask=roi_mask`: 可选的掩码参数，只处理掩码中非零的像素

**返回值：** 按位与运算后的图像

**在程序中的位置：** 第81-84行、第177行

**说明：** 这里用于将颜色掩码限制在 ROI 区域内

---

### 2. `cv2.bitwise_or()`

**功能：** 对两个图像进行按位或运算，用于合并掩码

**用法：**
```python
mask_medicine = cv2.bitwise_or(mask_medicine1, mask_medicine2)
```

**参数说明：**
- `mask_medicine1`: 第一个掩码
- `mask_medicine2`: 第二个掩码

**返回值：** 按位或运算后的图像

**在程序中的位置：** 第35行

**说明：** 用于合并红色的两个 HSV 范围（0-10° 和 170-180°）

---

## 五、轮廓检测与分析

### 1. `cv2.findContours()`

**功能：** 在二值图像中查找轮廓

**用法：**
```python
contours, _ = cv2.findContours(mask, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
```

**参数说明：**
- `mask`: 输入的二值图像（掩码）
- `cv2.RETR_EXTERNAL`: 轮廓检索模式
  - `RETR_EXTERNAL`: 只检测外部轮廓
  - `RETR_LIST`: 检测所有轮廓
  - `RETR_TREE`: 检测所有轮廓并建立层次结构
- `cv2.CHAIN_APPROX_SIMPLE`: 轮廓近似方法
  - `CHAIN_APPROX_SIMPLE`: 压缩水平、垂直和对角线段，只保留端点
  - `CHAIN_APPROX_NONE`: 存储所有轮廓点

**返回值：**
- `contours`: 轮廓列表，每个轮廓是一个点的数组
- `_`: 层次结构（本程序中未使用）

**在程序中的位置：** 第41行

---

### 2. `cv2.contourArea()`

**功能：** 计算轮廓的面积

**用法：**
```python
area = cv2.contourArea(contour)
valid_contours = [c for c in contours if cv2.contourArea(c) > min_area]
```

**参数说明：**
- `contour`: 轮廓点数组

**返回值：** 轮廓的面积（浮点数，单位：像素²）

**在程序中的位置：** 第53行、第58行、第62行

**说明：** 用于过滤小面积噪声，只保留有效轮廓

---

## 六、图像矩计算

### `cv2.moments()`

**功能：** 计算图像的矩，用于计算重心等特征

**用法：**
```python
M = cv2.moments(largest)
if M['m00'] > 0:
    cx = int(M['m10'] / M['m00'])
    cy = int(M['m01'] / M['m00'])
```

**参数说明：**
- `largest`: 轮廓点数组

**返回值：** 字典，包含各种矩值
- `M['m00']`: 零阶矩（面积）
- `M['m10']`: 一阶矩（x 方向）
- `M['m01']`: 一阶矩（y 方向）

**重心计算公式：**
- `cx = M['m10'] / M['m00']` (x 坐标)
- `cy = M['m01'] / M['m00']` (y 坐标)

**在程序中的位置：** 第66-70行

---

## 七、绘图函数

### 1. `cv2.rectangle()`

**功能：** 在图像上绘制矩形

**用法：**
```python
cv2.rectangle(roi_mask, (roi_x1, roi_y1), (roi_x2, roi_y2), 255, -1)
cv2.rectangle(frame, (roi_x1, roi_y1), (roi_x2, roi_y2), pattern_color, 3)
```

**参数说明：**
- `roi_mask` / `frame`: 目标图像
- `(roi_x1, roi_y1)`: 矩形左上角坐标
- `(roi_x2, roi_y2)`: 矩形右下角坐标
- `255` / `pattern_color`: 颜色（BGR 格式）
- `-1` / `3`: 线宽
  - `-1`: 填充矩形
  - 正数: 线条宽度（像素）

**返回值：** 无（直接修改输入图像）

**在程序中的位置：** 第166行、第222行、第224行

---

### 2. `cv2.putText()`

**功能：** 在图像上绘制文本

**用法：**
```python
cv2.putText(frame, status_text, (10, 30),
           cv2.FONT_HERSHEY_SIMPLEX, 0.7, status_color, 2)
```

**参数说明：**
- `frame`: 目标图像
- `status_text`: 要绘制的文本字符串
- `(10, 30)`: 文本左下角坐标（x, y）
- `cv2.FONT_HERSHEY_SIMPLEX`: 字体类型
- `0.7`: 字体缩放因子
- `status_color`: 文本颜色（BGR 格式）
- `2`: 线条宽度（像素）

**常用字体类型：**
- `FONT_HERSHEY_SIMPLEX`: 正常大小无衬线字体
- `FONT_HERSHEY_PLAIN`: 小号无衬线字体
- `FONT_HERSHEY_DUPLEX`: 正常大小无衬线字体（更复杂）
- `FONT_HERSHEY_COMPLEX`: 正常大小有衬线字体

**返回值：** 无（直接修改输入图像）

**在程序中的位置：** 第184-185行、第190-191行、第200-201行、第206-207行、第211-212行、第217-218行、第227-228行

---

## 八、窗口显示与控制

### 1. `cv2.imshow()`

**功能：** 在窗口中显示图像

**用法：**
```python
cv2.imshow("Enhanced Square Detection System", frame)
```

**参数说明：**
- `"Enhanced Square Detection System"`: 窗口名称
- `frame`: 要显示的图像

**返回值：** 无

**在程序中的位置：** 第231行

**说明：** 需要配合 `cv2.waitKey()` 使用才能正常显示

---

### 2. `cv2.waitKey()`

**功能：** 等待键盘输入，并更新窗口显示

**用法：**
```python
key = cv2.waitKey(1) & 0xFF
if key == ord('q'):
    break
```

**参数说明：**
- `1`: 等待时间（毫秒）
  - `0`: 无限等待
  - 正数: 等待指定毫秒数
- `& 0xFF`: 位运算，确保只取低 8 位（兼容性处理）

**返回值：** 按键的 ASCII 码值，如果没有按键则返回 -1

**在程序中的位置：** 第234行

**说明：** 
- 必须调用此函数才能更新窗口显示
- 用于实现实时视频显示和按键响应

---

### 3. `cv2.destroyAllWindows()`

**功能：** 关闭所有 OpenCV 创建的窗口

**用法：**
```python
cv2.destroyAllWindows()
```

**返回值：** 无

**在程序中的位置：** 第240行

**说明：** 程序退出前清理资源

---

## 九、OpenCV 常量

### 轮廓检索模式常量

#### `cv2.RETR_EXTERNAL`
- **值：** 0
- **含义：** 只检索外部轮廓
- **在程序中的位置：** 第41行

---

### 轮廓近似方法常量

#### `cv2.CHAIN_APPROX_SIMPLE`
- **值：** 2
- **含义：** 压缩水平、垂直和对角线段，只保留端点
- **在程序中的位置：** 第41行

---

### 颜色空间转换常量

#### `cv2.COLOR_BGR2HSV`
- **含义：** 从 BGR 颜色空间转换到 HSV 颜色空间
- **在程序中的位置：** 第76行、第175行

---

### 字体常量

#### `cv2.FONT_HERSHEY_SIMPLEX`
- **含义：** 正常大小的无衬线字体
- **在程序中的位置：** 多处 `putText` 调用

---

### 视频捕获属性常量

#### `cv2.CAP_PROP_FRAME_WIDTH`
- **含义：** 视频帧宽度属性
- **在程序中的位置：** 第137行

#### `cv2.CAP_PROP_FRAME_HEIGHT`
- **含义：** 视频帧高度属性
- **在程序中的位置：** 第138行

#### `cv2.CAP_PROP_FPS`
- **含义：** 视频帧率属性
- **在程序中的位置：** 第139行

---

## 函数使用流程图

```
程序启动
    ↓
cv2.VideoCapture(0)          # 打开摄像头
    ↓
cap.set()                     # 设置摄像头参数
    ↓
cap.read()                    # 读取帧
    ↓
cv2.cvtColor()                # BGR → HSV 转换
    ↓
cv2.inRange()                 # 颜色阈值处理
    ↓
cv2.bitwise_and()            # ROI 区域限制
    ↓
cv2.findContours()            # 查找轮廓
    ↓
cv2.contourArea()             # 计算轮廓面积
    ↓
cv2.moments()                 # 计算图像矩
    ↓
cv2.rectangle()               # 绘制ROI框
    ↓
cv2.putText()                 # 绘制文本信息
    ↓
cv2.imshow()                  # 显示图像
    ↓
cv2.waitKey()                 # 等待按键
    ↓
cap.release()                 # 释放资源
    ↓
cv2.destroyAllWindows()       # 关闭窗口
```

---

## 总结

本程序使用的 OpenCV 函数按功能分类：

1. **视频捕获**：5 个函数（VideoCapture, isOpened, set, read, release）
2. **颜色处理**：2 个函数（cvtColor, inRange）
3. **位运算**：2 个函数（bitwise_and, bitwise_or）
4. **轮廓分析**：2 个函数（findContours, contourArea）
5. **图像矩**：1 个函数（moments）
6. **绘图**：2 个函数（rectangle, putText）
7. **窗口控制**：3 个函数（imshow, waitKey, destroyAllWindows）

这些函数共同实现了实时视频捕获、颜色识别、轮廓检测和可视化显示的功能。